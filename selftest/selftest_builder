#!/bin/sh


DEFAULT="production"
BASEDIR="$PWD/${1:-$DEFAULT}"

seperator()  {
   echo "# -------------------------------------------------------------------------------------------------"
   echo
}

addtest()  {
   seperator
   FILE="$1"
   RELATIVEFILE="${FILE#$BASEDIR/}"
   echo "# $TESTCOUNT - $RELATIVEFILE"
   SUBCOUNT=0
   while read LINE ; do
      if [[ $LINE == {* ]] ; then
         (( SUBCOUNT++ ))
         RUN="test_${TESTCOUNT}_${SUBCOUNT}"
         echo -n "sub $RUN"
      fi
      LINE=$(sed "s~TEST~test_${TESTCOUNT}_~g;s~PASS~ $((TESTCOUNT*1000+SUBCOUNT)) pass~g" <<< $LINE)
      echo " $LINE"
   done < $FILE

   echo "sub test_${TESTCOUNT} { \"$RELATIVEFILE\" testfilename store$ test_${TESTCOUNT}_${SUBCOUNT} }"
   
   if (( SUBCOUNT )) ; then
      RUNTEST[TESTCOUNT]="test_${TESTCOUNT}"
      (( TESTCOUNT++ ))
   fi
   echo
}


header()  {
echo "#$1"
echo "# -----------------------------------------------------------------------"
echo "# eFTE self test script"
echo "# This file has been automatically generated by the eFTE packaging tools."
echo "# Manual changes to this file will very likely be lost, and may have an"
echo "# adverse effect on eFTE self testing capabilities."
echo "# Copyright (c) 2008 eFTE Group"
echo "# -----------------------------------------------------------------------"
}


if [[ ! -d $BASEDIR ]] ; then
   echo "test dir $BASEDIR doesn't exist"
   exit 1
fi


spaces() {
   NSPACES=${1:-0}
   while (( NSPACES-- )) ; do echo -n " " ; done
}

indent() {
   spaces $1
   shift
   echo -n "$*"
}   

indentcr() {
   indent "$@"
   echo 
}


(
header $BASEDIR
TESTCOUNT=1
cat pass

# --- add once section for every test ---
for FILE in $(find  $BASEDIR -type f | grep ".fte$") ; do
   echo "$TESTCOUNT - $FILE" 1>&2
   addtest $FILE
done

seperator

# --- pull all tests together ---
TESTSPERLINE=8
TABSIZE=5
INDENT=3

echo "sub selftest {"
indent $INDENT "beforealltests"

for (( i=1; i<$TESTCOUNT; i++ )) ; do
   if ! (( (i-1) % TESTSPERLINE )) ; then
      echo ; spaces $(( INDENT*2 ))
   fi

   echo -n "test_$i"

   if (( i % TESTSPERLINE )) ; then
      (( padding = TABSIZE - ${#i} ))
      if (( padding < 0 )) ; then padding=0 ; fi
      spaces $padding
   fi
   
done
echo 
indentcr $INDENT "afteralltests"
echo "}"
) > ../config/selftest.fte
