#!/bin/sh


DEFAULT="production"
BASEDIR="$PWD/${1:-$DEFAULT}"



addtest()  {
   FILE="$1"
   RELATIVEFILE="${FILE#$BASEDIR/}"
   echo "# $TESTCOUNT - $RELATIVEFILE"
   SUBCOUNT=0

   while read LINE ; do
      if [[ $LINE == {* ]] ; then
         (( SUBCOUNT++ ))
         RUN="test_${TESTCOUNT}_${SUBCOUNT}"
         echo -n "sub $RUN"
      fi
      LINE=$(sed "s~TEST~test_${TESTCOUNT}_~g;s~PASS~ $((TESTCOUNT*1000+SUBCOUNT)) \"$RELATIVEFILE\" pass~g" <<< $LINE)
      echo " $LINE"
   done < $FILE
   
   if (( SUBCOUNT )) ; then
      RUNTEST[TESTCOUNT]="$RUN"
      (( TESTCOUNT++ ))
   fi
   echo
}


header()  {
echo "#$1"
echo "# -----------------------------------------------------------------------"
echo "# eFTE self test script"
echo "# This file has been automatically generated by the eFTE packaging tools."
echo "# Manual changes to this file will very likely be lost, and may have an"
echo "# adverse effect on eFTE self testing capabilities."
echo "# Copyright (c) 2008 eFTE Group"
echo "# -----------------------------------------------------------------------"
}




if [[ ! -d $BASEDIR ]] ; then
   echo "test dir $BASEDIR doesn't exist"
   exit 1
fi

(
header $BASEDIR
TESTCOUNT=1
cat pass

for FILE in $(find  $BASEDIR -type f | grep ".fte$") ; do
   echo
   echo "$TESTCOUNT - $FILE" 1>&2
   addtest $FILE
done

echo

echo "sub selftest {"
echo -n "   \"selftest started\" type$ cr"

i=0
for SELFTEST in ${RUNTEST[*]} ; do
   if (( (i % 8) == 0 )) ; then
      echo ; echo -n "   "
   fi
   echo -n " $SELFTEST"
   (( i++ ))
done

echo
echo "   \"selftest finished\" type$ cr"
echo "}"
) > ../config/selftest.fte
