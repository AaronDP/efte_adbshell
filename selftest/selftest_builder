#!/bin/sh


addtest()  {
   SUBCOUNT=0
   while read LINE ; do
      if [[ $LINE == {* ]] ; then
         (( SUBCOUNT++ ))
         RUN="test_${TESTCOUNT}_${SUBCOUNT}"
         echo -n "sub $RUN"
      fi
      LINE=$(sed "s/TEST/test_${TESTCOUNT}_/g;s/PASS/ $((TESTCOUNT*1000+SUBCOUNT)) pass depth 0 $((TESTCOUNT*1000+SUBCOUNT)) pass/g" <<< $LINE)
      echo " $LINE"
   done < $FILE
   if (( SUBCOUNT )) ; then
      RUNTEST[TESTCOUNT]="$RUN"
      (( TESTCOUNT++ ))
   fi
   echo
}

(
TESTCOUNT=1
echo "# -----------------------------------------------------------------------"
echo "# eFTE self test script"
echo "# This file has been automatically generated by the eFTE packaging tools."
echo "# Manual changes to this file will very likely be lost, and may have an"
echo "# adverse effect on eFTE self testing capabilities."
echo "# Copyright (c) 2008 eFTE Group"
echo "# -----------------------------------------------------------------------"
cat pass
for FILE in components/* ; do
   echo
   echo "# $FILE"
   addtest $FILE
done
echo
echo "sub selftest {"
echo "\"selftest started\" message"
i=0
for SELFTEST in ${RUNTEST[*]} ; do
   if (( (i % 8) == 0 )) ; then
      echo ; echo -n "   "
   fi
   echo -n " $SELFTEST"
   (( i++ ))
done
echo
echo "depth 0 PASS"
echo
echo "   \"selftest finished\" message"
echo "}"
) > ../config/selftest.fte
